<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³½é´¿è¡€çµ±ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    form, .pigeon-list, .search-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .pigeon-item {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    img.preview {
      max-width: 100px;
      margin-top: 10px;
    }
    .edit-button {
      margin-top: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      margin-right: 5px;
    }
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>è³½é´¿è¡€çµ±ç®¡ç†ç³»çµ±</h1>

  <form id="pigeonForm">
    <label>é´¿åï¼š<input type="text" id="name"></label><br><br>
    <label>é´¿è™Ÿï¼š<input type="text" id="ringNumber" required></label><br><br>
    <label>æ€§åˆ¥ï¼š
      <select id="gender">
        <option value="å…¬">å…¬</option>
        <option value="æ¯">æ¯</option>
        <option value="æœªåˆ†">æœªåˆ†</option>
      </select>
    </label><br><br>
    <label>å‡ºç”Ÿå¹´ä»½ï¼š
      <select id="birthDate">
        <option value="">-- è«‹é¸æ“‡å¹´ä»½ --</option>
        <script>
          for (let y = 1990; y <= 2040; y++) {
            document.write(`<option value="${y}">${y}</option>`);
          }
        </script>
      </select>
    </label><br><br>
    <label>ç¾½è‰²ï¼š
      <select id="featherColor">
        <option value="ç´…">ç´…</option>
        <option value="é»‘æ–‘">é»‘æ–‘</option>
        <option value="é»‘æ–‘ç™½ç¾½">é»‘æ–‘ç™½ç¾½</option>
        <option value="æ–‘">æ–‘</option>
        <option value="æ–‘ç™½ç¾½">æ–‘ç™½ç¾½</option>
        <option value="é›¨é»">é›¨é»</option>
        <option value="é›¨é»ç™½ç¾½">é›¨é»ç™½ç¾½</option>
        <option value="ç°">ç°</option>
        <option value="ç°ç™½ç¾½">ç°ç™½ç¾½</option>
        <option value="é»‘ç°">é»‘ç°</option>
        <option value="æœªçŸ¥">æœªçŸ¥</option>
      </select>
    </label><br><br>
    <label>çœ¼è‰²ï¼š
      <select id="eyeColor">
        <option value="é»ƒçœ¼">é»ƒçœ¼</option>
        <option value="è¥¿çœ¼">è¥¿çœ¼</option>
        <option value="é»‘çœ¼">é»‘çœ¼</option>
        <option value="ä¸æ˜">ä¸æ˜</option>
      </select>
    </label><br><br>
    <label>è¡€çµ±ï¼š<input type="text" id="breed"></label><br><br>
    <label>çˆ¶é´¿è™Ÿï¼š<input type="text" id="fatherRing"></label><br><br>
    <label>æ¯é´¿è™Ÿï¼š<input type="text" id="motherRing"></label><br><br>
    <label>å‚™è¨»ï¼š<input type="text" id="notes"></label><br><br>
    <label>ä¸Šå‚³ç…§ç‰‡ï¼š<input type="file" id="photoInput" accept="image/*"></label><br>
    <img id="preview" class="preview"><br><br>
    <button type="submit">å„²å­˜</button>
  </form>

  <button type="button" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡ºç‚º Excel</button>

  <div class="search-box">
    <label>æœå°‹é—œéµå­—ï¼š<input type="text" id="searchInput" placeholder="è¼¸å…¥é´¿åã€é´¿è™Ÿã€ç¾½è‰²ã€çœ¼è‰²ã€è¡€çµ±ç­‰"></label>
  </div>

  <div class="pigeon-list" id="pigeonList"></div>

  <canvas id="pedigreeChart" style="display:none;"></canvas>

  <script>
    const form = document.getElementById('pigeonForm');
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const pigeonList = document.getElementById('pigeonList');
    const pedigreeChartCanvas = document.getElementById('pedigreeChart');
    const searchInput = document.getElementById('searchInput');
    const ringNumberInput = document.getElementById('ringNumber');

    let pigeons = JSON.parse(localStorage.getItem('pigeons') || '[]');
    let editIndex = null;
    let chart = null;

    function findPigeonByRing(ring) {
      return pigeons.find(p => p.ringNumber === ring);
    }

    function getPedigreeLabels(pigeon, generation = 1, labels = [], level = 0) {
      if (!pigeon || generation > 3) return labels;
      labels.push(`${'ã€€'.repeat(level)}${pigeon.ringNumber}`);
      getPedigreeLabels(findPigeonByRing(pigeon.fatherRing), generation + 1, labels, level + 1);
      getPedigreeLabels(findPigeonByRing(pigeon.motherRing), generation + 1, labels, level + 1);
      return labels;
    }

    function showPedigreeChart(pigeon) {
      const labels = getPedigreeLabels(pigeon);
      const data = {
        labels: labels.reverse(),
        datasets: [{
          label: 'è¡€çµ±å±¤ç´š',
          data: labels.map((_, i) => i + 1),
          backgroundColor: 'rgba(0, 123, 255, 0.5)'
        }]
      };

      if (chart) chart.destroy();
      chart = new Chart(pedigreeChartCanvas, {
        type: 'bar',
        data: data,
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'ä¸‰ä»£è¡€çµ±åœ–ç¤º' }
          }
        }
      });

      pedigreeChartCanvas.style.display = 'block';
    }

    function displayPigeons(filter = '') {
      pigeonList.innerHTML = '';
      const lowerFilter = filter.toLowerCase();
      pigeons.filter(p => {
        return [
          p.name, p.ringNumber, p.featherColor, p.eyeColor,
          p.breed, p.fatherRing, p.motherRing, p.notes
        ].some(field => (field || '').toLowerCase().includes(lowerFilter));
      }).forEach((pigeon, index) => {
        const div = document.createElement('div');
        div.className = 'pigeon-item';
        div.innerHTML = `
          <strong>${pigeon.ringNumber}</strong> (${pigeon.gender})<br>
          é´¿åï¼š${pigeon.name || ''}<br>
          å‡ºç”Ÿï¼š${pigeon.birthDate}<br>
          ç¾½è‰²ï¼š${pigeon.featherColor || ''}<br>
          çœ¼è‰²ï¼š${pigeon.eyeColor || ''}<br>
          è¡€çµ±ï¼š${pigeon.breed || ''}<br>
          çˆ¶é´¿è™Ÿï¼š${pigeon.fatherRing || ''}<br>
          æ¯é´¿è™Ÿï¼š${pigeon.motherRing || ''}<br>
          å‚™è¨»ï¼š${pigeon.notes || ''}<br>
          ${pigeon.photo ? `<img src="${pigeon.photo}" class="preview">` : ''}<br>
          <button class="edit-button" onclick="editPigeon(${index})">ç·¨è¼¯</button>
          <button class="edit-button" onclick="showPedigreeChart(pigeons[${index}])">åœ–è¡¨è¡€çµ±</button>
          <button class="edit-button" onclick="deletePigeon(${index})">åˆªé™¤</button>
        `;
        pigeonList.appendChild(div);
      });
    }

    function editPigeon(index) {
      const p = pigeons[index];
      document.getElementById('name').value = p.name || '';
      ringNumberInput.value = p.ringNumber;
      ringNumberInput.disabled = true; // ç¦æ­¢ç·¨è¼¯é´¿è™Ÿ
      document.getElementById('gender').value = p.gender;
      document.getElementById('birthDate').value = p.birthDate;
      document.getElementById('featherColor').value = p.featherColor;
      document.getElementById('eyeColor').value = p.eyeColor;
      document.getElementById('breed').value = p.breed || '';
      document.getElementById('fatherRing').value = p.fatherRing;
      document.getElementById('motherRing').value = p.motherRing;
      document.getElementById('notes').value = p.notes || '';
      preview.src = p.photo || '';
      editIndex = index;
    }

    function deletePigeon(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
        pigeons.splice(index, 1);
        localStorage.setItem('pigeons', JSON.stringify(pigeons));
        displayPigeons(searchInput.value);
      }
    }

    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(file);
      }
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const ringNumber = ringNumberInput.value;
      const gender = document.getElementById('gender').value;
      const birthDate = document.getElementById('birthDate').value;
      const featherColor = document.getElementById('featherColor').value;
      const eyeColor = document.getElementById('eyeColor').value;
      const breed = document.getElementById('breed').value;
      const fatherRing = document.getElementById('fatherRing').value;
      const motherRing = document.getElementById('motherRing').value;
      const notes = document.getElementById('notes').value;
      const photo = preview.src || '';

      const pigeonData = { name, ringNumber, gender, birthDate, featherColor, eyeColor, breed, fatherRing, motherRing, notes, photo };

      if (editIndex !== null) {
        pigeons[editIndex] = pigeonData;
        editIndex = null;
      } else {
        pigeons.push(pigeonData);
      }

      localStorage.setItem('pigeons', JSON.stringify(pigeons));
      ringNumberInput.disabled = false; // è®“ä¸‹ä¸€ç­†å¯ä»¥è¼¸å…¥é´¿è™Ÿ
      form.reset();
      preview.src = '';
      displayPigeons(searchInput.value);
    });

    searchInput.addEventListener('input', () => displayPigeons(searchInput.value));

    function exportToExcel() {
      if (pigeons.length === 0) {
        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º");
        return;
      }

      const wsData = [
        ["é´¿å", "é´¿è™Ÿ", "æ€§åˆ¥", "å‡ºç”Ÿå¹´ä»½", "ç¾½è‰²", "çœ¼è‰²", "è¡€çµ±", "çˆ¶é´¿è™Ÿ", "æ¯é´¿è™Ÿ", "å‚™è¨»"]
      ];

      pigeons.forEach(p => {
        wsData.push([
          p.name || "",
          p.ringNumber,
          p.gender,
          p.birthDate,
          p.featherColor,
          p.eyeColor,
          p.breed || "",
          p.fatherRing || "",
          p.motherRing || "",
          p.notes || ""
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Pigeons");
      XLSX.writeFile(wb, "é´¿èˆè³‡æ–™.xlsx");
    }

    displayPigeons();
  </script>
</body>
</html>
